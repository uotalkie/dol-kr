:: Clothing Shop v2 Widgets [widget]

<<widget "exitclothingshop">>
	<div class="button-back-to-shop div-link">
		<<if $clothes_choice and $shopDefaults.alwaysBackToShopButton is false>>
			<<link "뒤로">><<unset $clothes_choice>><<updateclotheslist>><<set $retrieveShopCustomColor to {}>><</link>>
		<<else>>
			<<link "매장으로 돌아간다">><<unset $clothes_choice>><<updateclothingshop>><<set _shopNameFilter to "">><<set $retrieveShopCustomColor to {}>><</link>>
		<</if>>
	</div>
<</widget>>

/*
	args[0] should be "clothing", "forest" or "school"
	args[1] is a slot: "upper", "lower", "under_upper", etc.
	args[2] should be "outfits" or missing. Combination of "over_upper", "upper" or "under_upper" in args[1] with "outfits" provides respective outfits category
*/
<<widget "clothingShopv2">>
	<<exitclothingshop>>
	<<if _args[0]>>
		<<set _shopLocation to _args[0]>>
	<</if>>
	<<if _args[1]>>
		<<set $clothingShopSlot to _args[1]>>
	<</if>>
	<<set _outfits to _args[2] == "outfits" or _args[2] == true>>

	<<if $shopClothingFilter is undefined>>
		<<shopClothingFilterReset>>
	<</if>>
	<<if $shopItemsPerPage is undefined>>
		<<set $shopItemsPerPage = 12>>
	<</if>>

	<<if $shopClothingFilter.active>>
		<span class="green">필터가 현재 적용되어 있습니다!</span>
		<<link "초기화">>
			<<shopClothingFilterReset>>
			<<updateclotheslist>>
		<</link>>
		<br><br>
	<</if>>
	<!-- Details about the selected item -->
	<div class="clothing-details">
		<<shopDetailsv2>>
	</div>

	<!-- Category tabs at the top of the list -->
	<<set _iconName to clothingSlotToIconName($clothingShopSlot, _outfits)>>
	<<shopCategoryTabs _iconName>>

	<!-- Search bar -->
	<<if !_shopNameFilter>>
		<<set _shopNameFilter to "">>
	<</if>>
	<span class="searchButtons">
		검색: <<textbox "_shopNameFilterTextbox" _shopNameFilter>>
		<<button 지운다>>
			<<set _shopNameFilter to "">>
			<<shopCategoryReplace `clothingSlotToIconName($clothingShopSlot, _outfits)`>>
		<</button>>
	</span>
		<<run $(() => {
		var shopTimer = null;
		$('#textbox--shopnamefiltertextbox').on('input change', e => {
			T.shopNameFilter = shopSearchReplacer(e.target.value);
			clearTimeout(shopTimer);
			shopTimer = setTimeout(updateShop, 300);
		});
		var updateShop = () => {
			new Wikifier (null, "<<shopCategoryReplace `clothingSlotToIconName($clothingShopSlot, _outfits)`>>");
			$('#textbox--shopnamefiltertextbox').focus();
		}
	})>>

	<!-- List of clothes -->
	<<set _items = setup.clothes[$clothingShopSlot].filter(x => x.shop.includes(_shopLocation) and x.outfitSecondary is undefined
		and ($clothingShopSlot === 'all'
			or
			(_outfits and x.outfitPrimary isnot undefined and Object.keys(x.outfitPrimary).some(secSlot => secSlot.includes("lower")))
			or
			(!_outfits and (x.outfitPrimary is undefined or Object.keys(x.outfitPrimary).every(secSlot => !secSlot.includes("lower")))))
		and (_shopNameFilter is '' or x.name.includes(_shopNameFilter.toLowerCase()))
	)>>
	<<set _items = applyClothingShopFilters(_items)>>
	<<set _maxPage = Math.ceil(_items.length / $shopItemsPerPage)>>
	<!-- Makes sure $shopPage is never showing a blank page -->
	<<if $shopPage gte _maxPage>>
		<<set $shopPage to 0>>
	<</if>>

	<div id="shop-list-pages" class="shop-list-pages">
		<!-- Generate current page immediately -->
		<<generateshoppage $shopPage>>

		<!-- Generate other pages in background after a delay, so that shop can be displayed sooner -->
		<!-- Having all pages loaded allows for very fast shop catalogue navigation -->
		<!-- Generate via <<repeat>> one by one to not cause a lag spike -->
		<<timed 0.2s>>
			<<set _ppre = $shopPage - 1>>
			<<repeat 0.1s>>
				<!-- Prepend pages before the current page -->
				<<if _ppre >= 0>>
					<<prepend '#shop-list-pages'>>
						<<generateshoppage _ppre>>
					<</prepend>>
					<<set _ppre-->>
				<<else>>
					<<stop>>
				<</if>>
			<</repeat>>
			<!-- Append pages after the current page -->
			<<set _papp = $shopPage + 1>>
			<<repeat 0.1s>>
				<<if _papp < _maxPage>>
					<<append '#shop-list-pages'>>
						<<generateshoppage _papp>>
					<</append>>
					<<set _papp++>>
				<<else>>
					<<stop>>
				<</if>>
			<</repeat>>
		<</timed>>
	</div>

	<!-- Pages -->
	<div id="shop-pagination" class="shop-pagination">
		<<set _disabled = $shopPage > 0 ? "" : "disabled">>
		<div @class="'div-link btn-pagination prev ' + _disabled">
			<<link "이전">>
				<<if $shopPage > 0>>
					<<set $shopPage -= 1>>
					<<clothingshopChangePage>>
				<</if>>
			<</link>>
			<div class="btn-pagination-arrow">&lt;</div>
		</div>
		<div class="shop-pages no-numberify">
			<<for _i = 0; _i < _maxPage; _i++>>
				<<capture _i>>
					<<set _active = _i == $shopPage ? "active" : "">>
					<div @class="'div-link page ' + _active">
						<<link "">>
							<<set $shopPage = _i>>
							<<clothingshopChangePage>>
						<</link>>
					</div>
				<</capture>>
			<</for>>
		</div>
		<div class="shop-pages-number hidden">
			<<print ($shopPage + 1) + " out of " + _maxPage>>
		</div>
		<<set _disabled = $shopPage < _maxPage - 1 ? "" : "disabled">>
		<div @class="'div-link btn-pagination next ' + _disabled">
			<<link "다음">>
				<<if $shopPage < _maxPage - 1>>
					<<set $shopPage += 1>>
					<<clothingshopChangePage>>
				<</if>>
			<</link>>
			<div class="btn-pagination-arrow">&gt;</div>
		</div>
	</div>

	<!-- Attach screen resize listener to replace circles in paginator with numbers when not enough space (22px per one circle is min) -->
	<<run $(window).on('resize', () => {
		let pagination = $('#shop-pagination');
		let pages = $(pagination).find('.shop-pages');
		let buttons = $(pagination).find('.btn-pagination');
		let isEnoughSpace = (pagination.width() - buttons.outerWidth() * 2 - 32) / pages.children().length >= 22;

		pages.toggleClass('hidden', !isEnoughSpace);
		pagination.find('.shop-pages-number').toggleClass('hidden', isEnoughSpace);
	})>>

	<!-- Filters -->
	<div class="filters-button no-numberify div-link">
		<<if $options.images is 1>>
			<span class="button-icon"><img src="img/misc/icon/filter.png"></span>
		<<else>>
			필터
		<</if>>
		<<link "">>
			<<replace '#filters'>><<loadFiltersMenu>><</replace>>
			<<run linkifyDivs('#filters')>>
			<<toggleclass '#filters' 'hidden'>>
		<</link>>
	</div>
	<div id="filters" class="no-click-overlay no-numberify hidden" onclick="$(this).addClass('hidden')">
		<!-- Don't load filters menu right away to not slow down shop loading -->
	</div>

	<!-- Options -->
	<div class="clothingshop-options-button no-numberify div-link">
		<<if $options.images is 1>>
			<span class="button-icon"><img src="img/misc/icon/options.png"></span>
		<<else>>
			Opt.
		<</if>>
		<<link "">>
			<<replace '#shop-options'>><<loadShopOptions>><</replace>>
			<<run linkifyDivs('#shop-options')>>
			<<toggleclass '#shop-options' 'hidden'>>
		<</link>>
	</div>
	<div id="shop-options" class="no-click-overlay no-numberify hidden" onclick="$(this).addClass('hidden')">
		<!-- Don't load options menu right away to not slow down shop loading -->
	</div>

	<!-- Help / Legend button -->
	<<if !$shopDefaults.noHelp>>
		<div class="shop-legend-button no-numberify div-link">
			<<if $options.images is 1>>
				<span class="button-icon"><img src="img/misc/icon/help.png"></span>
			<<else>>
				Help
			<</if>>
			<<link "">>
				<<toggleclass '#shop-legend' 'hidden'>>
				<<toggleclass '.shop-legend-button' 'active'>>
			<</link>>
		</div>
		<<clothingShopLegend>>
	<</if>>

	<!-- Finishing JS logic -->
	<<run linkifyDivs('#clothingShop-div')>>
	<<numberify '#clothingShop-div'>>
	<<run $(() => {
		_maxW = Math.max($('.btn-pagination.next').width(), $('.btn-pagination.prev').width());
		$('.btn-pagination.prev').width(_maxW);
		$('.btn-pagination.next').width(_maxW);
	})>>
<</widget>>

<<widget "clothingshopChangePage">>
	<!-- Make selected page visible -->
	<<run $('#shop-list-pages > div.clothing-shop-page').addClass('hidden no-numberify')>>
	<<run $('#shop-list-pages > div.clothing-shop-page:nth-of-type(' + ($shopPage + 1) + ')').removeClass('hidden no-numberify')>>

	<!-- Highlight selected page indicator -->
	<<run $('#shop-pagination > .shop-pages > div.page').removeClass('active')>>
	<<run $('#shop-pagination > .shop-pages > div.page:nth-of-type(' + ($shopPage + 1) + ')').addClass('active')>>

	<!-- Activate/deactivate Prev/Next buttons -->
	<<run $('#shop-pagination > .btn-pagination.prev').toggleClass('disabled', $shopPage <= 0)>>
	<<run $('#shop-pagination > .btn-pagination.next').toggleClass('disabled', $shopPage >= _maxPage - 1)>>

	<!-- Re-generate keyboard shortcuts -->
	<<run Links.generateLinkNumbers($('#clothingShop-div'))>>

	<!-- Change page number text on small screens -->
	<<replace '#shop-pagination > .shop-pages-number'>><<print ($shopPage + 1) + " out of " + _maxPage>><</replace>>
<</widget>>

<<widget "generateshoppage">>
	<<set _page = _args[0]>>
	<<set _itemsOnPage = _items.slice(_page * $shopItemsPerPage, (_page + 1) * $shopItemsPerPage)>>
	<<set _hidden = _page == $shopPage ? "" : " hidden">>
	<<set _compact = $shopDefaults.compactMode ? "compact" : "">>

	<<set _colCustomPrimary = getCustomColourStyle('primary')>>
	<<set _colCustomSecondary = getCustomColourStyle('secondary')>>

	<div @class="'clothing-shop-page page-' + _page + _hidden">
		<<for _itemTemp range _itemsOnPage>>
			<<set _item = clone(_itemTemp)>>
			<<set $_realSlot to ($clothingShopSlot is "all" ? _item.realSlot : $clothingShopSlot)>>
			<<set _itemData = setup.clothes[$_realSlot][clothesIndex($_realSlot,_item)]>>
			<<set _locked = $specialClothes[_item.name.replace(/ /g,"")] is "locked">>
			<<set _unlocked = $specialClothes[_item.name.replace(/ /g,"")] is "unlocked">>
			<div class="clothing-item div-link">
				<!-- Clothing icon -->
				<div @class="'clothing-icon ' + _compact">
					<<if _locked and $options.images is 1>>
						<img src="img/misc/icon/lock.png" class="clothing-locked">
					<<else>>
						<<if _item.colour_options.length > 0>>
							<<if $shopDefaults.colourItems == "random">>
								<<set _item.colour = _item.colour_options[random(_item.colour_options.length - 1)]>>
							<<elseif $shopDefaults.colourItems == "default" and _item.colour_options.includes($shopDefaults.color)>>
								<<set _item.colour = $shopDefaults.color>>
								<<if $shopDefaults.color == "custom">>
									<<set _item.colourCustom = _colCustomPrimary>>
								<</if>>
							<</if>>
						<</if>>
						<<if _item.accessory_colour_options.length > 0>>
							<<if $shopDefaults.colourItems == "random">>
								<<set _item.accessory_colour = _item.accessory_colour_options[random(_item.accessory_colour_options.length - 1)]>>
							<<elseif $shopDefaults.colourItems == "default" and _item.accessory_colour_options.includes($shopDefaults.secColor)>>
								<<set _item.accessory_colour = $shopDefaults.secColor>>
								<<if $shopDefaults.secColor == "custom">>
									<<set _item.accessory_colourCustom = _colCustomSecondary>>
								<</if>>
							<</if>>
						<</if>>
						<<clothingicon _item $_realSlot>>
						<!-- Gender icon -->
						<<if _item.gender isnot "n">>
							<span class="clothing-gender">
								<<if $shopDefaults.compactMode>>
									<<if _item.gender is "m">>
										<div class="male"></div>
									<<elseif _item.gender is "f">>
										<div class="female"></div>
									<</if>>
								<<else>>
									<<if $options.images is 1>>
										<<if _item.gender is "m">>
											<img src="img/misc/icon/male.png" class="male">
										<<elseif _item.gender is "f">>
											<img src="img/misc/icon/female.png" class="female">
										<</if>>
									<<else>>
										<<if _item.gender is "m">>
											<span class="male blue bold">♂</span>
										<<elseif _item.gender is "f">>
											<span class="female pink bold">♀</span>
										<</if>>
									<</if>>
								<</if>>
							</span>
						<</if>>
					<</if>>
				</div>

				<div @class="'clothing-body ' + _compact">
					<<if !$shopDefaults.compactMode>>
						<div class="pricetag-placeholder"></div>
					<</if>>
					<span class="clothing-name"><<trSearchClothes _itemData.name "name">>
						<<if _locked>>
							<span class="lblue">_trResult</span><span class="black">&nbsp;| 잠김</span>
						<<else>>
							<<set _csslot = $_realSlot>>
							<<capture _item _itemData _shopLocation _csslot _outfits>>
								<<link _trResult>>
									<<set $clothes_choice = clothesIndex(_csslot,_item)>>
									<<set $clothes_choice_reveal = _item.reveal>>
									<<set $clothes_choice_integrity = _itemData.integrity_max>>
									<<unset $colouraction>>
									<<unset $accessorycolouraction>>
									<<run window.scrollTo(0, 0)>>
									<<updateclotheslist _shopLocation _csslot _outfits>>
								<</link>>
							<</capture>>
							<<set $_count to getOwnedClothingCount(_item.index, $_realSlot)>>
							<<if $_count isnot 0>>
								<span class="white">
									&nbsp;|
									<<if !_compact>>
										소유:
									<</if>>
									$_count
								</span>
							<</if>>
							<<if _unlocked>>
								<span class="gold">&nbsp;| 풀림</span>
							<</if>>
						<</if>>
					</span>

					<<if _locked>>
						<div class="locked-hint">
							<<specialClothesHint>>
							<<print _specialClothesHint[_item.name.replace(/ /g,"")]>>
						</div>
					<<else>>
						<!-- Price tag -->
						<span class="clothing-price"><<printmoney `getClothingCost(_item, $_realSlot)` true>></span>
						<!-- Integrity, Reveal and Warmth indicators -->
						<<if !$shopDefaults.compactMode>>
							<div class="clothing-integrity">
								<<if $options.images is 1>>
									<img class="clothing-stats-icon" src="img/misc/icon/integrity.png">
								<<else>>
									<span class="clothing-stats-text">I.</span>
								<</if>>
								<<set _intInf = getIntegrityInfo(_item.integrity_max)>>
								<<for _i = 0; _i lt 7; _i++>>
									<span @class="'stats-ball ' + (_i < _intInf[0] ? 'bg-' + _intInf[1] : '')">&nbsp;</span>
								<</for>>
							</div>
							<div class="clothing-reveal">
								<<if $options.images is 1>>
									<img class="clothing-stats-icon" src="img/misc/icon/reveal.png">
								<<else>>
									<span class="clothing-stats-text">R.</span>
								<</if>>
								<<set _revInf = getRevealInfo(_item.reveal)>>
								<<for _i = 0; _i lt 7; _i++>>
									<span @class="'stats-ball ' + (_i < _revInf[0] ? 'bg-' + _revInf[1] : '')">&nbsp;</span>
								<</for>>
							</div>
							<div class="clothing-warmth">
								<<if $options.images is 1>>
									<img class="clothing-stats-icon" src="img/misc/icon/warmth.png">
								<<else>>
									<span class="clothing-stats-text">W.</span>
								<</if>>
								<<set _warInf = getWarmthInfo(getTrueWarmth(_item))>>
								<<for _i = 0; _i lt 5; _i++>>
									<span @class="'stats-ball ' + (_i < _warInf[0] ? _warInf[1] : '')">&nbsp;</span>
								<</for>>
							</div>
						<</if>>
						<<if !$shopDefaults.noTraits>>
							<!-- Trait icons -->
							<div class="clothing-traits">
								<<for _i, _trait range _item.type>>
									<<clothingtrait _trait>>
								<</for>>
							</div>
						<</if>>
					<</if>>
					<<if $shopDefaults.compactMode>>
						<div class="pricetag-placeholder"></div>
					<</if>>
				</div>
			</div>
		<</for>>

		<!-- Empty slots for padding when there's not enough clothes to show -->
		<<for _i = 0; _i < $shopItemsPerPage - _itemsOnPage.length; _i++>>
			<div @class="'clothing-item-spacer ' + _compact"></div>
		<</for>>

		<!-- Make div-links generated here clickable. -->
		<!-- Make sure to linkify ONLY this page, otherwise other, already linkified, divs will have two event handlers attached to them and will execute twice per click -->
		<<run linkifyDivs('#shop-list-pages > .clothing-shop-page.page-' + _page)>>
	</div>
<</widget>>

<<widget "updateclotheslist">>
	<<set _shop = _args[0] or _shopLocation>>
	<<set _slot = _args[1] or $clothingShopSlot>>
	<<set _outf = _args[2] or _outfits>>
	<<replace "#clothes-list">><<clothingShopv2 _shop _slot _outf>><</replace>>
<</widget>>

<<widget "clothingtrait">>
	<<if $options.images is 1 and (_args[1] or _args[0] isnot "normal")>>
		<<silently>><<shopTraitDescription _args[0]>><</silently>>
		<mouse class="tooltip-tiny black"><img @src="'img/misc/icon/clothes/traits/' + _args[0] + '.png'" class="clothing-trait">
		<<if _args[1] is undefined>><span><<trClothingTrait _clothesTrait>>_trResult</span><</if>>
		</mouse>
	<</if>>
<</widget>>

<<widget "shopDetailsv2">>
	<<unset _mannequinGenderOverride>>
	<<if $clothes_choice and setup.clothes[$clothingShopSlot][$clothes_choice] is undefined>>
		<<unset $clothes_choice>>

	<<elseif $clothes_choice>>
		<<set _temp_choice to clone(setup.clothes[$clothingShopSlot][$clothes_choice])>>
		<<set _realSlot to ($clothingShopSlot is "all" ? _item.realSlot : $clothingShopSlot)>>
		<<set _realIndex to _temp_choice.index>>

		<!-- Unlocked text -->
		<<if $specialClothes[_temp_choice.name.replace(/ /g,"")] is "unlocked">>
			<<specialClothesHint>>
			<div class="unlocked-hint">
				<span class="gold">풀림 | </span><span class="grey"><<print _specialClothesHint[_temp_choice.name.replace(/ /g,"")]>></span>
			</div>
			<br>
		<</if>>

		<<if _temp_choice.plural is 1>>
			<<integrity $clothes_choice_integrity "cap">>
		<<else>>
			<<integrity $clothes_choice_integrity>>
		<</if>>
		<<reveal $clothes_choice_reveal>> <<trSearchClothes _temp_choice.name "name">><<print _trResult>>.
		<<if _temp_choice.gender is "m">>
			<span class="lblue">남성용.</span>
		<<elseif _temp_choice.gender is "f">>
			<span class="pink">여성용.</span>
		<</if>>
		<<trSearchClothes _temp_choice.name "desc">><<print _trResult>> 가격 <<printmoney `getClothingCost(_temp_choice,$clothingShopSlot)`>>.
		<br>
		<<set _truewarmth = getTrueWarmth(_temp_choice)>>
		<<warmth _truewarmth>>
		<br><br>
		<<shoptraits>>
		<<set _slimeSlots to setup.clothingLayer.torso>>
		<<if !_slimeSlots.includes($clothingShopSlot) or currentSkillValue('willpower') gte 800 or _temp_choice.reveal gte 500 or _temp_choice.type.includesAny("school", "event") or $corruption_slime lt 80>>
			<div class="clothing-colours-div">
				<<set _hiddenMannequin = $options.images is 1 ? "" : "hidden">>
				<!-- Item preview -->
				<div id="mannequin" @class="'mannequin ' + _hiddenMannequin + ($options.sidebarRenderer is 'both' ? ' both-renderers' : '')">
					<<mannequin>>
				</div>
				<!-- Item colour selection -->
				<<set _translate = $options.images is 1 ? "translate-colours-container" : "">>
				<div @class="'colours-container ' + _translate">
					<div @class="'mannequin-placeholder ' + _hiddenMannequin"></div>
					<<if _temp_choice.colour_options.length gt 1>>
						<<run _temp_choice.colour_options.pushUnique("random")>>
						첫번째 색상 선택:
						<br>
						<<printShopColourOptions>>
					<</if>>
					<<if _temp_choice.accessory_colour_options.length isnot 0>>
						<<run _temp_choice.accessory_colour_options.pushUnique("random")>>
						<br>
						두번째 색상 선택:
						<br>
						<<printShopColourOptions "secondary">>
					<</if>>
				</div>
			</div>
			<<run attachCustomColourHooks($clothingShopSlot)>>

			<!-- Check if current clothing can be unequiped -->
			<<unset _cursedPrevent>>
			<<set _preventSlots to []>>
			<<if $worn[_realSlot].cursed is 1>>
				<<set _cursedPrevent to true>>
				<<run _preventSlots.push(_realSlot)>>
			<</if>>
			<<set _wardrobeSlots to [_realSlot]>>
			<<if _temp_choice.outfitPrimary isnot undefined>>
				<<for _slot, _name range _temp_choice.outfitPrimary>>
					<<run _wardrobeSlots.push(_slot)>>
					<<if $worn[_slot].cursed is 1>>
						<<set _cursedPrevent to true>>
						<<run _preventSlots.push(_slot)>>
					<</if>>
				<</for>>
			<</if>>

			<span>따뜻함:</span>
			<<warmthscale>>
			<div id="warmth-description">
				<<warmth_description>>
			</div>
			<br>
			<<if $multipleWardrobes is "all">>
				<span>의상 보내기:</span>
				<div id="sendItemsTo">
					<<sendItemsTo>>
				</div>
			<<else>>
				<<set $wardrobes.shopReturn to "wardrobe">>
			<</if>>
			<<shopBuyItemStatus _wardrobeSlots>>
			<<if _spaceLeft < 1>>
				<span class="blue">당신의 옷장은 가득 찼다.</span>
				<br>
			<<elseif $daystate is "night">>
				<<if $clothingShop.stolenClothes lte 20>>
					<<if $worn[_realSlot].cursed is 1>>
						<<printcursed>>
					<<else>>
						<<link "훔쳐 입는다">>
							<<shopbuyv2 _realSlot "steal" "wear" _realIndex>><<crimeup `getClothingCost(_temp_choice,$clothingShopSlot) / 100`>>
							<<set $clothingShop.stolenClothes++>>
							<<set $clothingShop.totalStolenClothes++>>
							<<if $shopDefaults.disableReturn is false>>
								<<unset $clothes_choice>>
							<</if>>
							<<updateclotheslist>>
							<<updatesidebarimg>>
							<<updatesidebarmoney>>
							<<updatesidebardescription>>
							<<updateallure>>
							<<if $shopDefaults.disableReturn>>
								<<updatewarmthscale>>
								<<updatewarmthdescription>>
							<</if>>
							<<run updateMoment()>>
						<</link>><<crime>>
						<br>
					<</if>>
					<<link "훔쳐 집으로 가져간다">>
						<<shopbuyv2 _realSlot "steal" "send" _realIndex>><<crimeup `getClothingCost(_temp_choice,$clothingShopSlot) / 100`>>
						<<set $clothingShop.stolenClothes++>>
						<<set $clothingShop.totalStolenClothes++>>
						<<if $shopDefaults.disableReturn is false>>
							<<unset $clothes_choice>>
						<</if>>
						<<updateclotheslist>>
						<<updatesidebarimg>>
						<<run updateMoment()>>
					<</link>><<crime>>
					<br>
				<<else>>
					<span class="red">당신은 이 이상 옷을 가지고 다닐 수 없다.</span> 당신은 옷들을 옷장에 가져가야 한다.
					<br>
				<</if>>
			<<elseif $money >= getClothingCost(_temp_choice,$clothingShopSlot)>>
				<<if _cursedPrevent>>
					<<printcursed>>
				<</if>>

				<div class="buy-buttons">
					<<set _cantWear = _cursedPrevent == true ? "disabled" : "div-link">>
					<div class="buy-button">
						<div @class="'buy-button-inner ' + _cantWear">
							<<if _cursedPrevent>>
								Buy and wear
							<<else>>
								<<link "옷을 산다">>
									<<clothingReset _realSlot>>
									<<shopbuyv2 _realSlot "buy" "wear" _realIndex>>
									<<set $money -= getClothingCost(_temp_choice,$clothingShopSlot)>>
									<<if $shopDefaults.disableReturn is "false">>
										<<unset $clothes_choice>>
									<</if>>
									<<updateclotheslist>>
									<<exposedcheck>>
									<<updatesidebarimg>>
									<<updatesidebarmoney>>
									<<updatesidebardescription>>
									<<updateallure>>
									<<if $shopDefaults.disableReturn>>
										<<updatewarmthscale>>
										<<updatewarmthdescription>>
									<</if>>
									<<run updateMoment()>>
								<</link>>
								(<<printmoney `getClothingCost(_temp_choice,$clothingShopSlot)`>>)
							<</if>>
						</div>
					</div>
					<<if $buyMultiple is undefined>>
						<<set $buyMultiple = 1>>
					<</if>>
					<div id="buy-send-home">
						<<printbuysendhome>>
					</div>
				</div>
			<<else>>
				<span class="pink">이것을 구입할 돈이 없다.</span>
				<br>
			<</if>>

			<<if _cursedPrevent != true and $tryOn.tryingOn>>
				<div class="try-buttons">
					<div class="try-button div-link">
						<<link "착용해 본다">>
							<<shopbuyv2 _realSlot "try" null _realIndex>>
							<<updateclotheslist>>
							<<exposedcheck>>
							<<updatesidebarimg>>
							<<updatesidebardescription>>
							<<updateallure>>
							<<updatewarmthscale>>
							<<updatewarmthdescription>>
							<<run updateMoment()>>
						<</link>>
					</div>
					<<if $tryOn.tryingOn[$clothingShopSlot] isnot null>>
						<div class="try-button div-link">
							<<link "돌려준다">>
								<<shopbuyv2 _realSlot "return" null _realIndex>>
								<<updateclotheslist>>
								<<exposedcheck>>
								<<updatesidebarimg>>
								<<updatesidebardescription>>
								<<updateallure>>
								<<updatewarmthscale>>
								<<updatewarmthdescription>>
								<<run updateMoment()>>
							<</link>>
						</div>
					<</if>>
					<<if $worn[$clothingShopSlot].name is _temp_choice.name and isConnectedToHood($clothingShopSlot)>>
						<!-- If selected item is a hood or selected item has a secondary hood piece -->
						<div class="try-button div-link"><<toggleHoodLink "shop">></div>
						<br>
					<</if>>
					<<if ["upper","lower"].includes($clothingShopSlot) and $worn.lower.name isnot "naked" and $worn.upper.outfitPrimary is undefined and !setup.clothes.upper[clothesIndex("upper",$worn.upper)].notuck>>
						<div class="try-button div-link"><<toggleUpperTuck>></div>
						<br>
					<</if>>
				</div>
			<</if>>
		<<else>>
			<span class="red">귀의 슬라임은 <<trSearchClothes _temp_choice.name "name" "을">>_trResult 입어보거나 구입하는 것을 허용하지 않습니다.</span>
			<br>
		<</if>>
	<</if>>
<</widget>>

<<widget "printbuysendhome">>
	<<set _clothingCost = getClothingCost(_temp_choice, $clothingShopSlot)>>
	<<set _canAfford = ($money >= _clothingCost * $buyMultiple and _spaceLeft >= $buyMultiple) ? "" : "disabled">>
	<div class="buy-button">
		<div @class="'buy-button-inner buy-multiple div-link ' + _canAfford">
			<<link `'옷을 사서 집으로 보낸다 × ' + $buyMultiple`>>
				<<if $money >= _clothingCost * $buyMultiple and _spaceLeft >= $buyMultiple>>
					<<clothingReset _realSlot>>
					<<shopbuyv2 _realSlot "buy" "send" _realIndex $buyMultiple>>
					<<set $money -= _clothingCost * $buyMultiple>>
					<<if $shopDefaults.disableReturn is false>>
						<<unset $clothes_choice>>
					<</if>>
					<<updateclotheslist>>
					<<updatesidebarimg>>
					<<updatesidebarmoney>>
					<<run updateMoment()>>
				<</if>>
			<</link>>
			<span>(<span class="gold"><<printmoney `_clothingCost * $buyMultiple`>></span>)</span>
		</div>

		<div id="buy-multiple-slider" class="buy-multiple-slider">
			<<numberslider "$buyMultiple" $buyMultiple 1 10 1>>
		</div>
		<!-- Update text of "Buy and send home" button -->
		<!-- <<run $(() => { $('#buy-multiple-slider input').on('change', () => { new Wikifier (null, "<<updateclotheslist>>") }); })>> -->
		<<run $(() => {
			$('#buy-multiple-slider input').on('input change', () => {
				let cost = getClothingCost(_temp_choice, $clothingShopSlot);
				let el = $('#buy-send-home > .buy-button > .buy-button-inner > a');
				let text = el.text().split(' ');
				text.pop();
				text.push($buyMultiple);
				el.text(text.join(' '));

				$('#buy-send-home > .buy-button > .buy-button-inner > span > span').text('£' + cost * $buyMultiple / 100);
				$('#buy-send-home > .buy-button > .buy-button-inner').toggleClass('disabled', $money < cost * $buyMultiple || _spaceLeft < $buyMultiple);
			});
		})>>
	</div>
<</widget>>

<<widget "updatebuysendhome">>
	<<replace "#buy-send-home">><<printbuysendhome>><</replace>>
	<<run linkifyDivs('#buy-send-home')>>
	<<numberify '#buy-send-home'>>
<</widget>>

<<widget "printShopColourOptions">>
	<<set _colourType = _args[0] == "secondary" ? "accessory_colour_options" : "colour_options">>

	<!-- Reset colour to default if invalid -->
	<<if _args[0] == "secondary" and !$accessorycolouraction>>
		<<if setup.clothes[$clothingShopSlot][$clothes_choice][_colourType].includes($shopDefaults.secColor)>>
			<<set $accessorycolouraction = $shopDefaults.secColor>>
		<<else>>
			<<set $accessorycolouraction = setup.clothes[$clothingShopSlot][$clothes_choice][_colourType][0]>>
		<</if>>
	<<elseif !$colouraction>>
		<<if setup.clothes[$clothingShopSlot][$clothes_choice][_colourType].includes($shopDefaults.color)>>
			<<set $colouraction = $shopDefaults.color>>
		<<else>>
			<<set $colouraction = setup.clothes[$clothingShopSlot][$clothes_choice][_colourType][0]>>
		<</if>>
	<</if>>
	<<set _acc = _args[0] == "secondary" ? "secondary" : "primary">>

	<!-- Generate button for each colour -->
	<<set _highContrast = $shopDefaults.highContrast ? "colour-name-span-highcontrast" : "colour-name-span">>
	<div @class="'colour-options-div no-numberify ' + _acc">
		<<for _buttonName range _temp_choice[_colourType]>>
			<<set _active = (_acc == "primary" ? $colouraction : $accessorycolouraction) == _buttonName ? "active" : "">>
			<div @class="'colour-button div-link ' + _active">
				<div @class="'bg-' + _buttonName.replace(/ /g, '-')">
					<<if $options.images is 1>>
						<<if _buttonName == "custom">>
							<img src="img/misc/icon/custom.png">
						<</if>>
						<<if _buttonName == "random">>
							<img src="img/misc/icon/random.png">
						<</if>>
					<</if>>
					<span @class="'capitalize ' + _highContrast"><<trColour _buttonName>>_trResult</span>
					<<capture _buttonName _args[0] _acc $clothingShopSlot>>
						<<link "">>
							<<if _buttonName == "random">>
								<<set $customColors.color[_acc] to random(0, 360)>> /* 0,360 are min/max hue values, representing colours */
								<<run updateHueSlider($customColors.color[_acc], _acc)>>
								<<set _colour = "custom">>
							<<else>>
								<<set _colour = _buttonName>>
							<</if>>
							<<if _args[0] == "secondary">>
								<<set $accessorycolouraction = _colour>>
							<<else>>
								<<set $colouraction = _colour>>
							<</if>>
							<<if _colour == "custom">>
								<<removeclass `".custom-colour." + _acc` "hidden">>
							<<else>>
								<<addclass `".custom-colour." + _acc` "hidden">>
							<</if>>
							<!-- Move .active class to the button that was pressed -->
							<<run $('.colour-options-div.' + _acc + ' > .colour-button').removeClass('active').find('.bg-' + _colour).parent().addClass('active')>>
							<<updatemannequin>>
						<</link>>
					<</capture>>
				</div>
			</div>
		<</for>>
		<!-- Update colour filters of custom colour button -->
		<<run $(() => { updateCustomColour('primary'); updateCustomColour('secondary'); })>>

		<!-- Set colouractions to default if they're undefined, set by clicking on respective buttons -->
		<<if _acc == "primary" and $colouraction is undefined>>
			<<run $(() => { $('.colour-options-div.primary > .colour-button > .bg-' + $shopDefaults.color + ' > a').click(); })>>
		<</if>>
		<<if _acc == "secondary" and $accessorycolouraction is undefined>>
			<<run $(() => { $('.colour-options-div.secondary > .colour-button > .bg-' + $shopDefaults.secColor + ' > a').click(); })>>
		<</if>>
	</div>

	<!-- Custom colour sliders -->
	<<if _args[0] == "secondary">>
		<<set _hidden = $accessorycolouraction == "custom" ? "" : " hidden">>
	<<else>>
		<<set _hidden = $colouraction == "custom" ? "" : " hidden">>
	<</if>>
	<<capture _acc $clothingShopSlot>>
		<div @class="'pt-1-em pc-c fw-wrap custom-colour ' + _acc + _hidden">
			<div @class="'custom-colour-sliders ' + _acc">
				/*<<set _varHue = "$customColors.color." + _acc>>
				<<set _varBri = "$customColors.brightness." + _acc>>
				<<set _varSat = "$customColors.saturation." + _acc>>*/
				<<set _varCon = "$customColors.contrast." + _acc>>
/* 				<div class="colour-slider"><span class="colour-slider-caption">Hue</span><<numberslider _varHue $customColors.color[_acc] 0 360 1>></div>
				<div class="colour-slider"><span class="colour-slider-caption">명도</span><<numberslider _varBri $customColors.brightness[_acc] 0 4 0.01>></div>
				<div class="colour-slider"><span class="colour-slider-caption">채도</span><<numberslider _varSat $customColors.saturation[_acc] 0 4 0.01>></div>
				<div class="colour-slider"><span class="colour-slider-caption">Contrast</span><<numberslider _varCon $customColors.contrast[_acc] 0 4 0.01>></div>*/
				<<setShopCustomColors _acc>>
				<<set $retrieveShopCustomColor[_acc] to true>>
				<<shopclothingcustomcolourwheel _acc>>
				<div class="colour-slider text-align-center elem-fill-available"><span class="colour-slider-caption">Contrast</span><<numberslider _varCon $customColors.contrast[_acc] 0 4 0.01>></div>
			</div>
			<div class="custom-colour-presets no-numberify preset-colour-options">
				<div class="presets-dropdown">
					<<if _preset_choice is undefined>><<set _preset_choice = {}>><</if>>
					<<listbox "_preset_choice[_acc]" autoselect>>
							<!-- Just... don't try to understand the next line. In short, it adds [L] to legacy preset names in dropdown -->
						<<optionsfrom {...{'---': '---'}, ...Object.keys($customColors.presets).reduce((acc, val) => ({...acc, [($customColors.presets[val].ver >= 2 ? '' : '[L] ') + val]: val }), {})}>>
					<</listbox>>
					<<set _delDisabled = Object.keys($customColors.presets).includes(_preset_choice[_acc]) ? "" : "disabled">>
					<div @class="'delete-preset div-link ' + _delDisabled">
						<<if $options.images is 1>><img src="img/misc/icon/delete.png"><<else>>Del<</if>>
						<<link "">>
							<<if _preset_choice[_acc] and $customColors.presets[_preset_choice[_acc]] and confirm('Delete preset "' + _preset_choice[_acc] + '"?')>>
								<<run delete $customColors.presets[_preset_choice[_acc]]>>
								<<updateclotheslist>>
								<<run updateMoment()>>
							<</if>>
						<</link>>
					</div>
				</div>
				<div class="save-preset div-link">
					<<if $options.images is 1>><img src="img/misc/icon/save.png"><<else>>Save<</if>>
					<<link "">>
						<<run saveCustomColourPreset(_acc)>>
						<<updateclotheslist>>
						<<run updateMoment()>>
					<</link>>
				</div>
				/* import/export custom colour buttons */
				<div class="import-export-buttons">
					<div class="colour-button div-link ">
						<div>
							<img src="img/ui/import-preset-colour.png">
							<span class="capitalize colour-name-span">import</span>
							<<link "">>
								<<run importCustomColour(_acc)>>
								<<run updateMoment()>>
							<</link>>
						</div>
					</div>
					<div class="colour-button div-link active">
						<div class="bg-custom-export">
						 	<img src="img/ui/export-preset-colour.png">
							<span class="capitalize colour-name-span">export</span>
							<<link "">>
								<<run exportCustomColour(_acc)>>
							<</link>>
						</div>
					</div>
				</div>
				<div id="export-custom-colour-box"></div>
			</div>
		</div>
	<</capture>>
<</widget>>

<<widget "setShopCustomColors">>
	<<if $retrieveShopCustomColor[_acc] is true>>
		<<set $retrieveShopCustomColor[_acc] to false>>
	<<else>>
		<<set $customColors.color[_acc] to 61>>
		<<set $customColors.contrast[_acc] to 1.46>>
		<<set $customColors.brightness[_acc] to 3.08>>
		<<set $customColors.value[_acc] to 100>>
		<<set $customColors.saturation[_acc] to 0.6016>>
		<<set $customColors.sepia[_acc] to 0>>
	<</if>>
<</widget>>

<<widget "printcursed">>
	<span class="blue">먼저 당신의
	<<set _preventClothes = _preventSlots.map(x => $worn[x].name)>><<set $_preventClothes to []>><<for $_i, $_value range _preventClothes>><<trSearchClothes $_value "name">><<set $_preventClothes.push(_trResult)>><</for>>
	<<set _trResult to formatList($_preventClothes)>><<trPost _postNum "을">><<print _trResult>> 벗지 않으면 입을 수 없다.</span>
	<br>
<</widget>>


<<widget "shopbuyv2">>
	<<set _slot to _args[0]>>
	<<set _action to _args[1]>>
	<<set _subaction to _args[2]>>
	<<set _choice_index to _args[3]>>
	<<set _amount to _args[4]>>
	<<set $clothes_choice_previous to $clothes_choice>>

	<<if _choice_index isnot undefined>>
		<<set $colouraction2 = $colouraction>>
		<<set $accessorycolouraction2 = $accessorycolouraction>>
	<</if>>

	<<if _action isnot "reset">>
		<<if _slot is "upper" or _slot is "lower">>
			<<ShowUnderEquip "normal">>
		<</if>>
		<<if _slot is "over_upper" or _slot is "over_lower" or _slot is "over_head">>
			<<ShowUnderEquip "over">>
		<</if>>
	<</if>>

	<<if _action is "buy" or _action is "steal">>
		You _action the <<print setup.clothes[_slot][_choice_index].name>>.
		<br><br>
		<<if $shopName is "school" and _action is "buy">>
			<<set $schoolShopAction.push("buy")>>
		<</if>>
	<<elseif _action is "try">>
		<<tryOnWear _slot _choice_index>>
		<<if $shopName is "school">>
			<<set $schoolShopAction.push("try")>>
		<</if>>
	<<elseif _action is "return">>
		<<clothingReset _slot>>
		<<if $shopName is "school">>
			<<set $schoolShopAction.push("return")>>
		<</if>>
	<<elseif _action is "reset">>
		<<unset $colouraction>>
		<<unset $colouraction2>>
		<<unset $accessorycolouraction>>
		<<unset $accessorycolouraction2>>
		<<set $shopDefaults.colorSet to null>>
		<<set $shopDefaults.secColorSet to null>>
	<</if>>

	<<if _subaction is "wear">>
		<<generalWear _slot _choice_index $colouraction2 $accessorycolouraction2>>
		<<updateOwned _slot>>
		<<if $shopName is "school">>
			<<set $schoolShopAction.push("wear")>>
		<</if>>
	<<elseif _subaction is "send">>
		<<set _loop to _amount or 1>>
		<<for _s = 0; _s lt _loop; _s++>>
			<<generalSend $wardrobes.shopReturn _slot _choice_index $colouraction2 $accessorycolouraction2>>
		<</for>>
	<</if>>

<</widget>>

<<widget "mannequin">>
	<<if $options.images is 1>>
		<<set _slot = _args[0] or _realSlot>>
		<<set _index = _args[1] or _realIndex>>
		<<set _item = setup.clothes[_slot][_index]>>

		<<if _item.colour_options.length > 0>>
			<<set _col = _args[2] or $colouraction or (_item.colour_options.includes($shopDefaults.color) ? $shopDefaults.color : _item.colour_options[0])>>
		<<else>>
			<<set _col = "">>
		<</if>>
		<<if _item.accessory_colour_options.length > 0>>
			<<set _acc_col = _args[3] or $accessorycolouraction or (_item.accessory_colour_options.includes($shopDefaults.secColor) ? $shopDefaults.secColor : _item.accessory_colour_options[0])>>
		<<else>>
			<<set _acc_col = "">>
		<</if>>

		<<if _item>>
			<!-- Set gender of the mannequin -->
			<<if _mannequinGenderOverride>>
				<<set _mannequinGender to _mannequinGenderOverride>>
			<<else>>
				<<if $shopDefaults.mannequinGenderFromClothes and _item.gender != "n">>
					<<set _mannequinGender to _item.gender>>
				<<else>>
					<<if $shopDefaults.mannequinGender is "same">>
						<<set _mannequinGender to $player.gender>>
					<<elseif $shopDefaults.mannequinGender is "opposite">>
						<<set _mannequinGender to ($player.gender is "f" ? "m" : "f")>>
					<<else>>
						<<set _mannequinGender to $shopDefaults.mannequinGender.first()>>
					<</if>>
				<</if>>
			<</if>>
			<<set $mannequinHasPenis to (_mannequinGender isnot "f")>>

			<<if _item.type.includes("chest_bind")>>
				<<set _breastImg to 0>>
			<<else>>
				<<set _breastImg to ($mannequinBreastsSize is undefined ? 3 : (_mannequinGender is "m" ? 0 : $mannequinBreastsSize))>>
			<</if>>
			<<set _clothed = (((_slot != "under_upper" and $options.neverNudeMenus) or (_slot == "under_upper" and !_item.type.includes("naked"))) and _breastImg >= 2) ? "_clothed" : "">>

			<div class="mannequin-inner">
				<<if $options.sidebarRenderer isnot "img">>
					<<selectmodel "main" "shop">>
						<<set _modeloptions.mannequin to true>>
						<<set _modeloptions.show_face to false>>
						<<set _modeloptions.show_hair to false>>
						<<set _modeloptions.breasts to _breastImg ? (_clothed ? "cleavage" : "default") : "">>
						<<set _modeloptions.breast_size to _breastImg>>
						<<set _modeloptions.crotch_visible to true>>
						<<if $mannequinHasPenis>>
							<<set _modeloptions.penis to "default">>
						<</if>>
						<<if $options.neverNudeMenus>>
							<<if _slot != "under_upper" and (_mannequinGender == "f" or _mannequinGender == "h")>>
								<<set _modeloptions.worn_under_upper to 12>>
								<<set _modeloptions.worn_under_upper_colour to "pale white">>
							<</if>>
							<<if _slot != "under_lower" and (_item.set == _slot or _slot != 'under_upper')>>
								<<if $mannequinHasPenis>>
									<<set _modeloptions.worn_under_lower to 0>>
									<<set _modeloptions.worn_under_lower_colour to "pale white">>
								<</if>>
							<</if>>
						<</if>>
						<!-- Draw primary and all secondary items -->
						<<set _items_list = [{slot: _slot, item: _item}]>>
						<<if _item.outfitPrimary>>
							<<set _items_list = _items_list.concat(Object.keys(_item.outfitPrimary).map(s => { return {slot: s, item: setup.clothes[s].find(x => x.name == _item.outfitPrimary[s])} }))>>
						<</if>>
						<<for _clothing range _items_list>>
							<<set _item = _clothing.item>>
							<<set _slot = _clothing.slot>>
							<<set _modeloptions['worn_' + _slot] to clothesIndex(_slot,_item)>>
							<<if _col>>
								<<set _modeloptions['worn_' + _slot + '_colour'] to _col>>
								<<if _col is "custom">>
									<<set _modeloptions.filters["worn_" + _slot + "_custom"] =
											getCustomClothesColourCanvasFilter($customColors.color.primary,
												$customColors.saturation.primary,
												$customColors.brightness.primary,
												$customColors.contrast.primary);>>
								<</if>>
							<</if>>
							<<if _acc_col>>
								<<set _modeloptions['worn_' + _slot + '_acc_colour'] to _acc_col>>
								<<if _acc_col is "custom">>
									<<set _modeloptions.filters["worn_" + _slot + "_acc_custom"] =
											getCustomClothesColourCanvasFilter($customColors.color.secondary,
												$customColors.saturation.secondary,
												$customColors.brightness.secondary,
												$customColors.contrast.secondary);>>
								<</if>>
							<</if>>
						<</for>>
						<<if $options.sidebarRenderer is "both">>
							<<set _item = _items_list[0].item>>
							<<set _slot = _items_list[0].slot>>
						<</if>>
					<<rendermodel "canvas-mannequin">>
				<</if>>

				<<if $options.sidebarRenderer isnot "canvas">>
				<div class="mannequin-body">
					<img src="img/body/mannequin/leftarmidle.png">
					<img src="img/body/mannequin/basenoarms.png">
					<img src="img/body/mannequin/rightarmidle.png">
					<img src="img/body/mannequin/basehead.png">
					<img @src="'img/body/mannequin/breasts/' + _breastImg + _clothed + '.png'">
					<<if $mannequinHasPenis>>
						<img src="img/body/mannequin/penis.png">
					<</if>>

					<<if $options.neverNudeMenus>>
						<div class="neverNudeMenus">
							<<if _slot != "under_upper" and (_mannequinGender == "f" or _mannequinGender == "h")>>
								<div class="layer-under_upper clothes-pale-white">
									<img src="img/clothes/under_upper/plainbra/full.png">
									<img @src="'img/clothes/under_upper/plainbra/' + _breastImg + '.png'">
								</div>
							<</if>>
							<<if _slot != "under_lower" and (_item.set == _slot or _slot != 'under_upper')>>
								<div class="layer-under_lower clothes-pale-white">
									<img src="img/clothes/under_lower/plainpanties/full.png">
									<<if $mannequinHasPenis>>
										<img src="img/clothes/under_lower/plainpanties/penis.png">
									<</if>>
								</div>
							<</if>>
						</div>
					<</if>>
				</div>
				<</if>> <!-- renderer switch -->

				<!-- Mannequin gender toggle button -->
				<div class="mannequin-buttons no-numberify">
					<div class="div-link mannequin-gender-button">
						<<if $options.images is 1>>
							<<set _genderIcon = (_mannequinGender == "m" ? "male" : (_mannequinGender == "f" ? "female" : "unisex"))>>
							<img @src="'img/misc/icon/' + _genderIcon + '.png'">
						<<else>>
							<span class="capitalize">_manequinGender[0]</span>
						<</if>>
						<<link "">><<toggleMannequinGender>><</link>>
					</div>
				</div>

				<<if $options.sidebarRenderer isnot "canvas">>
				<div class="mannequin-clothes">
					<<unset _styleP>>
					<<unset _styleS>>
					<!-- Draw primary and all secondary items -->
					<<set _items_list = [{slot: _slot, item: _item}]>>
					<<if _item.outfitPrimary>>
						<<set _items_list = _items_list.concat(Object.keys(_item.outfitPrimary).map(s => { return {slot: s, item: setup.clothes[s].find(x => x.name == _item.outfitPrimary[s])} }))>>
					<</if>>
					<<for _clothing range _items_list>>
						<<set _item = _clothing.item>>
						<<set _slot = _clothing.slot>>

						<<if _col is "custom">>
							<<set _styleP = getCustomColourStyle('primary')>>
						<</if>>
						<div @class="'clothes-' + _col.replace(/ /g, '-')" @style="_styleP">
							<<if _item.mainImage isnot 0>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/full.png'">
							<</if>>

							<<if setup.clothes[_slot][clothesIndex(_slot,_item)].sleeve_img or _item.leftImage>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/left.png'">
							<</if>>
							<<if setup.clothes[_slot][clothesIndex(_slot,_item)].sleeve_img or _item.rightImage>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/right.png'">
							<</if>>

							<<if setup.clothes[_slot][clothesIndex(_slot,_item)].breast_img>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/' + _breastImg + '.png'">
							<</if>>

							<<if _item.penis_img and $mannequinHasPenis>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/penis.png'">
							<</if>>
						</div>

						<<if _acc_col is "custom">>
							<<set _styleS = getCustomColourStyle('secondary')>>
						<</if>>
						<div @class="'clothes-' + _acc_col.replace(/ /g, '-')" @style="_styleS">
							<<if _item.accessory and _slot != "hands">>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + (_item.accessory_integrity_img ? '/acc_full.png' : '/acc.png')">
							<</if>>
							<<if _item.breast_acc_img>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/' + _breastImg + '_acc.png'">
							<</if>>
							<<if _item.leftImage and _item.accessory>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/left_acc.png'">
							<</if>>
							<<if _item.rightImage and _item.accessory>>
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/right_acc.png'">
							<</if>>
						</div>
						<<if _item.back_img is 1>>
							<<set _back_col = _item.back_img_colour is 'secondary' ? _acc_col.replace(/ /g, '-') : _col.replace(/ /g, '-')>>
							<div @class="'clothes-' + _back_col" @style="'z-index: -1; position: absolute; ' + _styleS">
								<img @src="'img/clothes/' + _slot + '/' + _item.variable + '/' + 'back.png'">
							</div>
						<</if>>
					<</for>>
				</div>
				<</if>> <!-- renderer switch -->
			</div>
			<div class="div-link mannequin-gender-textbutton no-numberify">
				성별 바꾸기
				<<link "">><<toggleMannequinGender>><</link>>
			</div>
		<</if>>
	<</if>>
<</widget>>

<<widget "toggleMannequinGender">>
	<<if _mannequinGender is "f">>
		<<set _mannequinGenderOverride to "m">>
	<<else>>
		<<if $player.gender is "h" and _mannequinGender is "m">> /* if player is herm, toggle mannequin through herm gender */
			<<set _mannequinGenderOverride to "h">>
		<<else>>
			<<set _mannequinGenderOverride to "f">>
		<</if>>
	<</if>>
	<<updatemannequin>>
<</widget>>

<<widget "updatemannequin">>
	<<replace "#mannequin">><<mannequin _args[0] _args[1]>><</replace>>
	<<run linkifyDivs('#mannequin')>>
<</widget>>

<<widget "updatesidebardescription">>
	<<replace '#sidebar-look-description'>><<sidebarlookdescription>><</replace>>
<</widget>>

<<widget "updatesidebarmoney">>
	<<if $options.images>>
		<<replace #stats>><<statsCaption>><</replace>>
	<<else>>
		<<replace #money-noimg>><<statsMoneyNoImg>><</replace>>
	<</if>>
<</widget>>

<<widget "loadFiltersMenu">>
	<div class="filters-div" onclick="event.stopPropagation()">
		<div id="filter-buttons" class="filter-buttons-div">
			<div class="filter-button button-apply div-link">
				<<link "적용하고 닫는다">>
					<<set $shopClothingFilter.active = true>>
					<<set $shopPage to 0>>
					<<addclass '#filters' 'hidden'>>
					<<updateclotheslist>>
					<<run updateMoment()>>
				<</link>>
			</div>
			<div class="filter-button button-reset div-link">
				<<link "전부 초기화하고 닫는다">>
					<<shopClothingFilterReset>>
					<<updateclotheslist>>
					<<run updateMoment()>>
				<</link>>
			</div>
			<div class="filter-button button-toggle-traits div-link">
				<<link "전체 특성을 선택 / 해제 한다">>
					<<run toggleAllTraitsFilter()>>
				<</link>>
			</div>
		</div>
		<div class="filters">
			<div id="filter-gender" class="filter-block">
				<<if typeof $shopClothingFilter.gender isnot "object">>
					<<set $shopClothingFilter.gender = { female: true, neutral: true, male: true }>>
				<</if>>

				<span class="bold gold">성별</span>
				<label><<checkbox "$shopClothingFilter.gender.female" false true autocheck>> 여성용</label>
				<label><<checkbox "$shopClothingFilter.gender.neutral" false true autocheck>> 남녀 공용</label>
				<label><<checkbox "$shopClothingFilter.gender.male" false true autocheck>> 남성용</label>
			</div>

			<div id="filter-reveal" class="filter-block">
				<<filterreveal>>
			</div>

			<div id="filter-warmth" class="filter-block">
				<<if $shopClothingFilter.warmth is undefined>>
					<<set $shopClothingFilter.warmth = { from: 0, to: 200 }>>
				<</if>>

				<span class="bold gold">온열</span>
				<div class="filter-warmth-fromto">
					<label><<numberbox "$shopClothingFilter.warmth.from" $shopClothingFilter.warmth.from>>에서 </label>
					<label><<numberbox "$shopClothingFilter.warmth.to" $shopClothingFilter.warmth.to>>까지</label>
				</div>
			</div>

			<div id="filter-traits" class="filter-block">
				<span class="bold gold">특성</span>
				<div class="traits-list">
					<<set _traitsInThisShop = [...new Set(Object.keys(setup.clothes).flatMap(x => setup.clothes[x]).filter(x => x.shop.includes(_shopLocation)).flatMap(x => x.type))]>>
					<<for _trait range _traitsInThisShop.sort()>>
						<<silently>><<shopTraitDescription _trait>><</silently>>
						<div class="filters-trait-row">
							<label>
								<<set _checked = $shopClothingFilter.traits.includes(_trait) ? 'checked="checked"' : ''>>
								<<clothingtrait _trait 'display_normal'>>
								<<print '<input type="checkbox" @id="_trait" @value="_trait" ' + _checked + ' onclick="window.shopClothingFilterToggleTrait(this.value)">'>>
								<<if $noTraitDescription>>
									<<trClothingTrait _clothesTrait>>_trResult
								<<else>>
									<mouse class = "tooltip-small">
										<<trClothingTrait _clothesTrait>>_trResult
										<span class="black"><<print _clothesDesc>></span>
									</mouse>
								<</if>>
							</label>
						</div>
					<</for>>
				</div>
			</div>
		</div>
	</div>
<</widget>>

<<widget "filterreveal">>
	<<if $shopClothingFilter.reveal.from is undefined>>
		<<set $shopClothingFilter.reveal.from = 0>>
	<</if>>
	<<if $shopClothingFilter.reveal.to is undefined>>
		<<set $shopClothingFilter.reveal.to = 9999>>
	<</if>>
	<span class="bold gold">노출 정도</span>
	<div class="filter-reveal-fromto">
		<label><<listbox "$shopClothingFilter.reveal.from" autoselect>><<optionsfrom getFilterRevealOptions('from')>><</listbox>>에서 </label>
		<label><<listbox "$shopClothingFilter.reveal.to" autoselect>><<optionsfrom getFilterRevealOptions('to')>><</listbox>>까지</label>
	</div>

	<<run $(() => { $('#filter-reveal select').on('change', (e) => { new Wikifier(null, "<<replace '#filter-reveal'>><<filterreveal>><</replace>>"); }) })>>
<</widget>>

<<widget "loadShopOptions">>
	<div class="options-div" onclick="event.stopPropagation()">
		<div id="options-buttons" class="options-buttons-div">
			<div class="options-button button-apply div-link">
				<<link "저장하고 닫는다">>
					<<addclass '#shop-options' 'hidden'>>
					<<updateclotheslist>>
					<<run updateMoment()>>
				<</link>>
			</div>
		</div>
		<div class="options-body">
			<<set _colorOptions to ["black", "blue", "brown", "green", "pink", "purple", "red", "tangerine", "teal", "white", "yellow", "custom", "random"]>>

			<br>
			기본 첫번째 색상:
			<br>
			<<for _col range _colorOptions>><<trColour _col>>
				<label>
					<<radiobutton "$shopDefaults.color" _trResult autocheck>>
					<span @class="_col">_trResult</span>
				</label>
				|
			<</for>>
			<br><br>
			기본 두번째 색상:
			<br>
			<<for _col range _colorOptions>><<trColour _col>>
				<label>
					<<radiobutton "$shopDefaults.secColor" _trResult autocheck>>
					<span @class="_col">_trResult</span>
				</label>
				|
			<</for>>
			<br><hr>

			<label>
				<<checkbox "$shopDefaults.disableReturn" false true autocheck>>
				옷을 산 후 목록으로 돌아가지 않는다.
			</label>
			<br><hr>

			<label>
				<<checkbox "$shopDefaults.alwaysBackToShopButton" false true autocheck>>
				항상 "매장으로 돌아간다" 버튼을 보여준다.
			</label>
			<br><hr>

			<<if $shopDefaults.colourItems is undefined>>
				<<set $shopDefaults.colourItems = "random">>
			<</if>>
			<label>
				목록의 색상표 표시:
				<<listbox "$shopDefaults.colourItems" autoselect>>
					<<option "표시하지 않는다" "disable">>
					<<option "임의의 색상을 사용한다" "random">>
					<<option "기본 색상을 사용한다" "default">>
				<</listbox>>
			</label>
			<br><hr>

			<label>
				목록의 각 페이지에서 표시할 옷의 갯수:
				<<listbox "$shopItemsPerPage" autoselect>>
					<<optionsfrom [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32]>>
				<</listbox>>
			</label>
			<br><hr>

			<div class="high-contrast-example">
				<label>
					<<checkbox "$shopDefaults.highContrast" false true autocheck>>
					색상 이름을 고대비로 표시한다.
				</label>
				&nbsp;&nbsp;예:&nbsp;&nbsp;
				<div class="colour-button"><div class="bg-pink"><span class="capitalize colour-name-span">분홍색</span></div></div>
				&nbsp;<span style="margin-right:0.25em">대</span>&nbsp;
				<div class="colour-button"><div class="bg-pink"><span class="capitalize colour-name-span-highcontrast">분홍색</span></div></div>
			</div>
			<hr>

			<label>
				<<checkbox "$shopDefaults.mannequinGenderFromClothes" false true autocheck>>
				마네킹의 성별을 옷의 성별과 맞춘다 (남녀 공용의 경우 아래의 성별을 따라감).
			</label>
			<br>
			<label>
				마네킹의 성별:
				<<listbox "$shopDefaults.mannequinGender" autoselect>>
					<<option "플레이어와 동일" "same">>
					<<option "플레이어와 반대" "opposite">>
					<<option "항상 남성" "male">>
					<<option "항상 여성" "female">>
				<</listbox>>
			</label>
			<br>
			<label>
				마네킹 가슴 크기:
				<<listbox "$mannequinBreastsSize" autoselect>>
					<<optionsfrom {"평평함": 0 , "조그마함": 1, "작음": 2, "봉긋함": 3, "큼": 4, "매우 큼": 5}>>
				<</listbox>>
			</label>
			<br><hr>

			<label>
				<<checkbox "$shopDefaults.compactMode" false true autocheck>>
				목록에 표시되는 정보를 줄여 목록을 작게 한다.
			</label>
			<br>
			<label>
				<<checkbox "$shopDefaults.noTraits" false true autocheck>>
				옷의 특성 아이콘을 숨긴다.
			</label>
			<br>
			<label>
				<<checkbox "$shopDefaults.noHelp" false true autocheck>>
				목록의 도움말 / 범례 버튼을 보이지 않게 한다.
			</label>
		</div>
	</div>
<</widget>>

<<widget "clothingShopLegend">>
	<div id="shop-legend" class="shop-legend hidden">
		<div class="legend-caption bold gold">범례</div>
		<br>

		<<if $options.images is 1>>
			<div>
				<img src="img/misc/icon/integrity.png">
				내구도 등급. 옷이 얼마나 잘 찢어져 조각나지 않는가.
			</div>
			<div>
				<img src="img/misc/icon/reveal.png">
				노출 등급. 옷이 얼마나 당신을 색기있게 보여주는가.
			</div>
			<div>
				<img src="img/misc/icon/warmth.png">
				온열 등급. 옷이 얼마나 당신을 추위에서 보호해 주는가.
			</div>
			<br>

			<div class="legend-2em">
				<img src="img/misc/icon/options.png">
				옷가게 옵션.
			</div>
			<div class="legend-2em">
				<img src="img/misc/icon/filter.png">
				옷가게 필터.
			</div>
			<br>
		<<else>>
			I - 내구도 등급. 옷이 얼마나 잘 찢어져 조각나지 않는가.
			<br>
			R - 노출 등급. 옷이 얼마나 당신을 색기있게 보여주는가.
			<br>
			W - 온열 등급. 옷이 얼마나 당신을 추위에서 보호해 주는가.
		<</if>>

		<div class="legend-warmth">
			<div class="legend-warmth-div">
				<<warmthscale $warmth+25>>
			</div>
			온열 지표.
			<br>
			날씨에 따라 편안함을 느끼는 온도 범위를 표시한다.
			<br>
			<div class="legend-colour-sample" style="background-color: dodgerblue"></div> - 이 온도에서는 당신은 무척 추울 것이다
			<br>
			<div class="legend-colour-sample" style="background-color: lightskyblue"></div> - 이 온도에서는 당신은 약간 쌀쌀함을 느낄 것이다
			<br>
			<div class="legend-colour-sample" style="background-color: lemonchiffon"></div> - 완벽한 온도이다
			<br>
			<div class="legend-colour-sample" style="background-color: orange"></div> - 이 온도에서는 당신은 약간 덥다고 느낄 것이다
			<br>
			<div class="legend-colour-sample" style="background-color: orangered"></div> - 이 온도에서는 당신은 무척 더울 것이다
			<br>
			<div class="legend-icon"><img src="img/misc/icon/warmth_indicator.png"></div> - 당신이 현재 입고 있는 옷으로 느끼는 따뜻함
			<br>
			<div class="legend-icon"><img src="img/misc/icon/small_uarrow.png"></div> - 다른 옷으로 갈아입었을 때 당신이 느낄 따뜻함
		</div>
	</div>
<</widget>>

<<widget "warmthscale">>
	<div class="warmth-scale-container">
		<<warmthscale-internal _args[0]>>
	</div>
<</widget>>

<<widget "updatewarmthscale">>
	<<temperature>>
	<<replace '.warmth-scale-container'>><<warmthscale-internal>><</replace>>
<</widget>>

<<widget "updatewarmthdescription">>
	<<replace '#warmth-description'>><<warmth_description>><</replace>>
<</widget>>

<<widget "warmthscale-internal">>
	<<if _args[0]>>
		<<set _newWarmth = _args[0]>>
	<<elseif $clothes_choice>>
		<<set _newWarmth = getWarmthWithOtherClothing(_realSlot, _realIndex)>>
	<</if>>
	<<set _warmthData = getWarmthScaleData(_newWarmth)>>

	<div class="warmth-scale-div">
		<div class="cold" @style="'width: ' + _warmthData.cold"></div>
		<div @class="'chill ' + _warmthData.nocold" @style="'width: ' + _warmthData.chill"></div>
		<div @class="'ok ' + _warmthData.nowarm" @style="'width: ' + _warmthData.ok"></div>
		<div @class="'warm ' + _warmthData.nohot" @style="'width: ' + _warmthData.warm"></div>
		<div class="hot" @style="'width: ' + _warmthData.hot"></div>

		<<if $clothes_choice or _args[0]>>
			<div @class="'diff ' + _warmthData.diffUpDown" @style="'left: ' + _warmthData.diffStart + '; width: ' + _warmthData.diffWidth"></div>
		<</if>>
	</div>

	<img src="img/misc/icon/warmth_indicator.png" class="warmth-indicator" @style="'left: ' + _warmthData.player">
	<<if $clothes_choice or _args[0]>>
		<img src="img/misc/icon/small_uarrow.png" class="warmth-indicator" @style="'left: ' + _warmthData.playerNew">
	<</if>>
<</widget>>

<<widget "sendItemsTo">>
<div class="returnOptions no-numberify">
	<<for _label, _value range $wardrobes>>
		<<if _value.unlocked and _value.shopSend>><<trWardrobeName _value.name>>
			<<if $wardrobes.shopReturn is _label>>
				<div class="try-button div-link">
					<span class="gold"><<print _trResult>></span>
				</div>
			<<else>>
				<div class="try-button div-link">
					<<capture _label>>
						<<link _trResult>>
							<<set $wardrobes.shopReturn to _label>>
							<<updateclotheslist>>
							<<updatesidebardescription>>
							<<updatewarmthscale>>
							<<updatewarmthdescription>>
							<<run updateMoment()>>
						<</link>>
					<</capture>>
				</div>
			<</if>>
		<</if>>
	<</for>>
</div>
<</widget>>

<<widget "sendItemsToDropdown">>
<<if $multipleWardrobes is "all">>
	<label>보내는 옷장:
	<<set _options to {}>>
	<<for _label, _value range $wardrobes>>
		<<if _value.unlocked and !$wardrobes[_label].isolated>>
			<<trWardrobeName _value.name>><<set _options[_trResult] to _label>>
		<</if>>
	<</for>>
	<<listbox '$wardrobes.shopReturn' autoselect>>
		<<optionsfrom _options>>
	<</listbox>>
	</label>
	<br>
<<else>>
	<<set $wardrobes.shopReturn to "wardrobe">>
<</if>>
<</widget>>

/*If the player just goes to the shop and puts up their hood, make sure whatever they had on their head doesn't just disappear*/
<<widget "shopHoodCheck">>
	<<if $tryOn.tryingOn.head is null and $tryOn.ownedStored.head.name isnot "naked" and $tryOn.ownedStored.head.name isnot $worn.head.name and $worn.head.hood is 1>>
		<<wardrobeSend "head" $tryOn.ownedStored.head>>
	<</if>>
<</widget>>
